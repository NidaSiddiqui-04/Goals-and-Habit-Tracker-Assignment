
{%extends 'navbar.html'%}
{%block content%}
<div class="container mt-5" style="width: 30rem;">
    <div class="shadow-lg p-3 mb-5 bg-body rounded">

    <div class="row justify-content-center p-5">
       
  <div class=" profile-container">
    <h1 class="text-center">My Profile         <img id="badgeicon" class="icon mt-0" src=""  style="width: 70px;">
</h1>
    <div class="col-12 text-center">
    <img id="avatarImg" class="avatar mb-0 rounded-circle img-fluid" src="" alt="User Avatar">
    </div>
    <div class="col-12">
        <div id="badge_des" class="text-center"></div>
    </div>
    
    <ul class="list-group">
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">Username:</span> <span id="username" class="fw-bold"></span></div></li>
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">Email:</span> <span id="email" class="fw-bold"></span></div></li>
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">Name:</span> <span id="name" class="fw-bold"></span></div></li>
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">Bio :</span> <span id="bio" class="fw-bold"></span></div></li>
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">XP :</span> <span id="xp_points" class="fw-bold"></span></div></li>
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">Level :</span> <span id="level" class="fw-bold"></span></div></li>
    <li class="list-group-item"><div class="profile-detail"><span class="profile-label ps-5">Streaks  :</span> <span id="streaks" class="fw-bold"></span></div></li>
 <li class="list-group-item">
  <div class="profile-detail">
 <div id="badgesContainer" ></div>
</span>
  </div>
</li>

</ul>
<div class="col-12 text-center">
    <!-- Add more fields if your API returns more details -->
    <button id="editProfileBtn" class="btn btn-outline-success mt-2">Edit Profile</button>
</div>
  </div>
  </div>
    </div>
  </div>
{%endblock%}
{%block scripts%}
  <script>
    const access = localStorage.getItem('accessToken');
  
  async function fetchProfileAndBadges() {
    try {
      // Fetch profile
      const profileRes = await fetch('/api/auth/me/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${access}`
        }
      });
      if (!profileRes.ok) {
        throw new Error(`HTTP error! Status: ${profileRes.status}`);
      }
      const data = await profileRes.json();
 
      document.getElementById('username').textContent = data.username || '';
      document.getElementById('email').textContent = data.email || '';
      document.getElementById('name').textContent = `${data.first_name || ''} ${data.last_name || ''}`;
      document.getElementById('bio').textContent=data.bio;
      document.getElementById('xp_points').textContent = data.xp_points || '0';
      document.getElementById('level').textContent = data.level || '';
      document.getElementById('streaks').textContent = data.streak_count+'ðŸ”¥' || '';
      const avatarImg = document.getElementById('avatarImg');
      avatarImg.src = data.avatar || '/static/images/default_avatar.png';

      
      await fetchBadges();
    } catch (error) {
      console.error('Error fetching profile or badges:', error);
      
    }
  }

   async function fetchBadges() {
    try {
      const res = await fetch('/api/user_badges/', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${access}`
          // 'Content-Type': 'application/json' // not required for GET
        }
      });
      if (!res.ok) {
        throw new Error(`Error fetching badges: ${res.status}`);
      }
      const data = await res.json();
      // if response key is something like { badges: [...] }
      const badges = Array.isArray(data) ? data : (data.badges || []);
      const container = document.getElementById('badgesContainer');
      const des=document.getElementById('badge_des');
      const icon=document.getElementById('badgeicon');
      if (!badges.length) {
        container.innerHTML = '<p class="text-center fw-bold">No badges found.</p>';
      } else {
        container.innerHTML = '';  
        badges.forEach(user_badge => {
          const badgeElem = document.createElement('div');
          badgeElem.innerHTML =`<p class="ps-5">Badges :<strong>${user_badge.badge.name}</strong></p> `; 
          container.appendChild(badgeElem);
          icon.src=user_badge.badge.icon
          des.innerHTML=`<h3>${user_badge.badge.description}</h3>`
        });
      }
    } catch (error) {
      console.error('Error fetching badges:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    fetchProfileAndBadges();

    document.getElementById('editProfileBtn').addEventListener('click', () => {
      window.location.href = '/profile/edit/';
    });
  });
  </script>
{%endblock scripts%}
