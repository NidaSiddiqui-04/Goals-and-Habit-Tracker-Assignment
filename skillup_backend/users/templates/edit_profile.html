{% extends 'navbar.html' %}


{% block content %}
<div class="container mt-5" style="width: 25rem;">
  <div class="shadow-lg p-3 mb-5 bg-body rounded">
    <div class="row justify-content-center p-5">
      <div class="profile-container">
        <h1 class="text-center">Edit Profile</h1>

        <form id="profileEditForm">
          {% csrf_token %}
          <div class="mb-3">
            <img src="" id="image">
            <input type="file" id="avatar" name="avatar" >

          </div>
          <div class="mb-3">
            <label for="inputUsername" class="form-label">Username</label>
            <input type="text" name="username" id="inputUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="inputEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="inputEmail" name="email" required>
          </div>
          <div class="mb-3">
            <label for="inputFirstName" class="form-label">First Name</label>
            <input type="text" class="form-control" id="inputFirstName" name="first_name">
          </div>
          <div class="mb-3">
            <label for="inputLastName" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="inputLastName" name="last_name">
          </div>
          <div class="mb-3">
            <label for="bio" class="form-label">Bio</label>
            <input type="text" name="bio" id="bio" class="form-control">
          </div>
          <!-- Add more editable fields if needed -->
          <button type="submit" class="btn btn-outline-success">Save Changes</button>
          <a href="{% url 'user_profile' %}" class="btn btn-outline-danger">Cancel</a>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}



<script>
  let access = localStorage.getItem('accessToken');

  async function refreshToken() {
    const refresh = localStorage.getItem('refresh');
    const res = await fetch('http://localhost:8000/api/auth/refresh/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh })
    });
    if (res.ok) {
      const data = await res.json();
      localStorage.setItem('accessToken', data.accessToken);
      return data.accessToken;
    } else {
      alert('Session expired. Please log in again.');
      window.location.href = '/login/';
    }
  }

  document.addEventListener('DOMContentLoaded', async function() {
    try {
      access = localStorage.getItem('accessToken');  // get fresh token
      const res = await fetch('http://localhost:8000/api/auth/me/', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${access}`
        }
      });
      if (!res.ok) throw new Error(`Failed to fetch profile: ${res.status}`);
      const data = await res.json();
      const img = document.getElementById('image');
      img.src = data.avatar;

      document.getElementById('inputUsername').value = data.username || "";
      document.getElementById('inputEmail').value = data.email || "";
      document.getElementById('inputFirstName').value = data.first_name || "";
      document.getElementById('inputLastName').value = data.last_name || "";
      document.getElementById('bio').value = data.bio || "";
    } catch (err) {
      console.error('Error fetching profile for edit:', err);
      alert('Could not load profile data.');
    }
  });

  const avatarElem = document.getElementById('avatar');

  document.getElementById('profileEditForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    access = localStorage.getItem('accessToken');
    const formData = new FormData();
    formData.append('avatar', avatarElem.files[0]);

    formData.append('username', document.getElementById('inputUsername').value);
    formData.append('email', document.getElementById('inputEmail').value);
    formData.append('first_name', document.getElementById('inputFirstName').value);
    formData.append('last_name', document.getElementById('inputLastName').value);
    formData.append('bio', document.getElementById('bio').value);

    try {
      const res = await fetch('http://localhost:8000/api/auth/me/', {
        method: "PUT",
        headers: {
          'Authorization': `Bearer ${access}`
        },
        body: formData
      });

      if (!res.ok) {
        const errData = await res.json();
        console.error('Update failed:', errData);
        alert('Failed to update profile.');
        return;
      }

      const updated = await res.json();
      console.log('Profile updated successfully:', updated);
      window.location.href = "{% url 'user_profile' %}";
    } catch (error) {
      console.error('Error updating profile:', error);
      alert('Something went wrong.');
    }
  });
</script>

{% endblock scripts %}
