


{%extends 'navbar.html'%}
{%block content%}
<hr/>
<div class="container mt-4">
   <h1 class="fw-bold ps-4 my-3">{{today}}</h1>

   <div class="row row-cols-4 text-center">
      <div class="col "><div class="rounded-pill  p-2"  style="background-color: rgb(132, 153, 79);">    <p class="fs-2 fw-bold">Total Goals</p> <span id="no-of-goals" class=" fw-bold fs-4">Loadingâ€¦</span></div>
   </div>
   <div class="col"> <div class="rounded-pill  p-2" style="background-color: rgb(255, 231, 151);"> <p class="fs-2 fw-bold">Total XP </p>
   <span id="total-xp-points"  class="fw-bold fs-4">Loadingâ€¦</span></div></div>
   <div class="col">
    <div class="rounded-pill  p-2" style="background-color: rgb(252, 181, 59);"><p class="fs-2 fw-bold">Streaks</p><span id="streaks" class="fw-bold fs-4">Loadingâ€¦</span></div></div>
   <div class="col">
        <div class="rounded-pill  p-2" style="background-color:rgb(180, 82, 83);"> <p class="fs-2 fw-bold">Level</p><span id="level" class="fw-bold fs-4">Loadingâ€¦</span></div>

   </div>
 

</div>
<div class="container mt-4">
  <div class="row justify-content-center"><div class="col-12"><canvas id="goalsProgressChart" class="w-75" style="margin-left: 150px;"></canvas>
</div></div>    
</div>

   {%endblock%}
  {%block scripts%}
   <script>
      let API=`http://localhost:8000/api/analytics/overview/`;
      let access=localStorage.getItem('accessToken')
      async function refreshToken() {
      const refresh = localStorage.getItem('refresh');
      const res = await fetch('http://localhost:8000/api/auth/refresh/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ refresh })
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('access', data.accessToken);
        return data.accessToken;
      } else {
        alert('Session expired. Please log in again.');
        window.location.href = '/login/';
      }
    }     
    async function loadDashboard() {
      try {
        const response =await fetch(API,{
         method:'GET',
         headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${access}`
         }
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        
        document.getElementById('no-of-goals').textContent = data.no_of_goals;
        document.getElementById('total-xp-points').textContent = data.total_xp_point;
        document.getElementById('streaks').textContent = data.streaks+'ðŸ”¥';
        document.getElementById('level').textContent = data.level;
      } catch (error) {
        console.error('Error fetching dashboard data:', error);
    
      }
    }

    
    window.addEventListener('DOMContentLoaded', loadDashboard);


   fetch('http://localhost:8000/api/weekly/report/', {
       method:'GET',
         headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${access}`
         }
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      const goalNames = data.goals.map(g => g.goal_name);
      const goalPercents = data.goals.map(g => g.goal_percentage);

      const ctx = document.getElementById('goalsProgressChart').getContext('2d');
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: goalNames,
          datasets: [{
        
            data: goalPercents,
            backgroundColor: goalPercents.map(p => p >= 100 ? 'rgba(75,192,192,0.7)' : 'rgba(255,99,132,0.7)'),
            borderColor: goalPercents.map(p => p >= 100 ? 'rgba(75,192,192,1)' : 'rgba(255,99,132,1)'),
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: { display: true, text: 'Percent complete (%)' }
            }
          },
          plugins: {
            title: {
              display: true,
              text: `Week: ${data.week_start} â†’ ${data.week_end}`
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + '%';
                }
              }
            }
          }
        }
      });
    })
    .catch(error => {
      console.error('Error fetching weekly report:', error);
      // optionally show a message to user
    });
  </script>

 
{%endblock scripts%}